This is the order in which the coding agent should read and work on the prompts:

prompt-006-baseline-script-instruction,
prompt-001-create-app-service,
prompt-017-create-managed-identity,
prompt-002-create-azure-sql,
prompt-008-use-existing-db,
prompt-026-Monitoring,
prompt-027-deployment-script,
prompt-029-unified-deployment-script,
prompt-028-github-actions-cicd,
prompt-004-create-app-code,
prompt-022-display-error-messages,
prompt-005-deploy-app-code,
prompt-007-add-api-code,
prompt-016-sqlcmd-for-sql,
prompt-024-sqlcmd-stored-procedures,
prompt-009-create-genai-resources,
prompt-010-add-chat-ui,
prompt-020-model-function-calling,
prompt-018-extra-genai-instructions,
prompt-025-clientid-for-chat,
prompt-019-chatui-deploy-file,
prompt-011-azure-services-diagram,
prompt-023-deployment-order-considerations

## CRITICAL: No Shell Scripts

Do NOT create .sh, .bash, or any shell script files. All deployment automation must use PowerShell (.ps1) scripts that work on Windows.

The infrastructure deployment supports a -DeployGenAI switch for optional GenAI resources - there is no need for separate deployment scripts.

## How the Deployment Scripts Work Together

The infrastructure script (prompt-027) and app deployment script (prompt-005) are designed to work as a seamless pair:

1. Run the infrastructure script first - it creates all Azure resources and saves a context file
2. Run the app script second - it reads that context file so you don't need to re-enter any values

## Critical: Connection String Must Be Set During Infrastructure Deployment

The infrastructure deployment script MUST configure these App Service settings:

- **ConnectionStrings__DefaultConnection** - The SQL connection string with Managed Identity authentication
- **AZURE_CLIENT_ID** - The managed identity client ID

Without these, the application won't be able to connect to the database, even if all the resources exist.

See prompt-008-use-existing-db and prompt-025-clientid-for-chat for the exact formats required.

## Troubleshooting

If you run into deployment issues, check prompt-023-deployment-order-considerations for common problems and how to solve them.

## Don't Skip the Chat Page

The prompt-010-add-chat-ui creates the Chat page files (Chat.cshtml, Chat.cshtml.cs, and ChatService.cs). These files must always be created, even when GenAI resources aren't being deployed. The chat page should display a friendly "not configured" message when GenAI isn't available, rather than being missing entirely.

If you notice these files are missing after a build, go back and run prompt-010-add-chat-ui to create them.

## Before You Finish

Do a quick check to make sure these key files exist:

- src/ExpenseManagement/Pages/Chat.cshtml
- src/ExpenseManagement/Pages/Chat.cshtml.cs
- src/ExpenseManagement/Services/ChatService.cs
- deploy-infra/deploy.ps1
- deploy-app/deploy.ps1
- deploy-all.ps1

Also verify the deploy-all.ps1 script uses hashtable splatting (not array splatting) when calling child scripts. See prompt-029-unified-deployment-script for the correct pattern.

## Common Pitfalls to Avoid

These issues have caused problems in past builds - please avoid them:

1. **PowerShell script-to-script parameter passing**: When one PowerShell script calls another with parameters, use hashtable splatting (`@{ Key = Value }`) not array splatting (`@("-Key", Value)`). Array splatting causes "positional parameter cannot be found" errors.

2. **Azure CLI parameter passing**: When calling `az deployment group create --parameters`, you cannot pass a PowerShell hashtable. Use inline `key=value` pairs instead. Passing a hashtable causes "Unable to parse parameter: System.Collections.Hashtable" errors.

3. **Azure CLI JSON output with warnings**: When capturing Azure CLI output for JSON parsing, use `2>$null` to discard stderr, not `2>&1` to merge it. Bicep warnings go to stderr and corrupt the JSON, causing "Conversion from JSON failed" errors.

4. **Missing Chat page**: The Chat.cshtml page must always be created, even without GenAI. It should gracefully show "not configured" instead of being absent.

5. **Bicep utcNow() usage**: Never use `utcNow()` in variable declarations - it's only allowed as a parameter default value.

6. **SQL connection string format**: Must include `Authentication=Active Directory Managed Identity;User Id={clientId}` - don't use `Trusted_Connection` or Windows auth.

7. **Resource naming**: Azure OpenAI and AI Search names must be lowercase. Apply `toLower()` when using `uniqueString()`.

8. **Sqlcmd piping**: Never pipe SQL directly to sqlcmd - always write to a temp file first, then use `-i` to execute it.

## Reference the Working Scripts

If you're unsure about the correct implementation pattern for any of these pitfalls, examine the existing scripts in the repository. These files contain working, tested code:

- `deploy-all.ps1` - Shows correct hashtable splatting for script-to-script calls
- `deploy-infra/deploy.ps1` - Shows correct Azure CLI parameter passing and stderr handling
- `src/ExpenseManagement/Pages/Chat.cshtml` - Shows graceful degradation when GenAI isn't configured

These files are your source of truth. If a prompt seems unclear, check how the pattern is implemented in these reference files.

## One More Thing

If a prompt file can't be found with the exact name listed, just skip it and move on to the next one - don't try to guess what it should contain.
