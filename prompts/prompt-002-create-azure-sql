Create the Bicep code for an Azure SQL Database with security-first configuration.

Save this as `deploy-infra/modules/azure-sql.bicep` and make sure it can be called from `deploy-infra/main.bicep`.

## Security Requirements

### Entra ID Only Authentication (No SQL Passwords)

This is a mandatory governance requirement - we must use Azure AD-only authentication:

- Set `azureADOnlyAuthentication: true` in the administrators configuration
- SQL username/password authentication must be completely disabled
- This complies with the MCAPS "[SFI-ID4.2.2] SQL DB - Safe Secrets Standard" policy

**Important Bicep Compatibility:** The SQL Server API requires an `administratorLoginPassword` field even when using AD-only authentication. You MUST use a secure parameter with `newGuid()` as the default value:

```bicep
@secure()
param sqlAdminPassword string = newGuid()
```

Then reference it in the resource: `administratorLoginPassword: sqlAdminPassword`

This is required because `newGuid()` can only be used as a parameter default value in Bicep, not directly in resource properties. Using `administratorLoginPassword: newGuid()` directly will cause a BCP065 error in newer Bicep versions.

### Entra ID Administrator

Configure the person deploying as the SQL server administrator:

- Use Entra ID (Azure AD) authentication
- Include their Object ID and User Principal Name
- The deployment script will retrieve these automatically from Azure CLI
- Support both User (interactive) and Application (Service Principal for CI/CD) principal types via an `adminPrincipalType` parameter

### Managed Identity Access

The managed identity created earlier needs database access. The deployment script handles this automatically by creating a database user for the managed identity and granting these database-level permissions:

- db_datareader role (read access)
- db_datawriter role (write access)  
- EXECUTE permission (for stored procedures)

Do NOT use server-level roles like ##MS_DatabaseManager## as the managed identity only needs database-level access.

See also: prompt-016-sqlcmd-for-sql for the SID-based user creation approach.

## Database Configuration

- Database name: 'Northwind'
- Tier: Basic (sufficient for development and testing)
- Enable the firewall rule for Azure services so other Azure resources can connect

## Schema Import

The database schema needs to be imported after the SQL Server is created.

Use sqlcmd (the modern go-sqlcmd tool) with Entra ID authentication - NOT Python scripts or ODBC drivers.

The schema file location: `Database-Schema/database_schema.sql`

The infrastructure deployment script handles this automatically. For manual execution:

    sqlcmd -S "sql-server.database.windows.net" -d "Northwind" "--authentication-method=ActiveDirectoryDefault" -i "Database-Schema/database_schema.sql"

This prompt creates infrastructure only - the SQL Server and database resources. Application code deployment is handled separately.
