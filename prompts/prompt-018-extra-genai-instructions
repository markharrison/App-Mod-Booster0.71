Extra guidance for integrating Azure OpenAI with the App Service using Managed Identity authentication.

## The Circular Dependency Problem

When configuring OpenAI settings, there's a chicken-and-egg problem in Bicep:

1. The App Service needs the Managed Identity first
2. The GenAI resources need the Managed Identity ID for role assignments
3. The App Service settings need the OpenAI endpoint (which doesn't exist until GenAI deploys)

This can't be solved in Bicep alone. The deployment script must configure App Service settings AFTER infrastructure deployment completes.

## Bicep Structure

Organise the templates like this:

- **app-service.bicep**: Creates the Managed Identity and App Service
- **genai.bicep**: Creates Azure OpenAI, grants the Managed Identity the "Cognitive Services OpenAI User" role, and outputs openAIEndpoint, openAIModelName, openAIName
- **main.bicep**: Orchestrates everything and conditionally deploys genai.bicep

## Deployment Script Steps

After the Bicep deployment finishes, the script must:

1. Retrieve the OpenAI endpoint and model name from deployment outputs:

       az deployment group show --query "properties.outputs.openAIEndpoint.value"

2. Configure the App Service with these values:

       az webapp config appsettings set --settings "GenAISettings__OpenAIEndpoint=$OPENAI_ENDPOINT" "GenAISettings__OpenAIModelName=$OPENAI_MODEL_NAME"

Do NOT try to set GenAI settings in the Bicep app settings directly - this creates an unresolvable circular dependency.

## Application Code

The C# code should:

- Use the Azure.Identity package with DefaultAzureCredential (not API keys)
- Read settings from configuration: GenAISettings:OpenAIEndpoint and GenAISettings:OpenAIModelName
- Create the OpenAIClient using the managed identity for authentication

See also: prompt-009-create-genai-resources, prompt-025-clientid-for-chat
