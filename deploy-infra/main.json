{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "8292457999490805310"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "uksouth",
      "metadata": {
        "description": "The Azure region for all resources"
      }
    },
    "baseName": {
      "type": "string",
      "defaultValue": "expensemgmt",
      "metadata": {
        "description": "Base name for resources"
      }
    },
    "adminObjectId": {
      "type": "string",
      "metadata": {
        "description": "SQL Server Administrator Object ID"
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "SQL Server Administrator Username"
      }
    },
    "adminPrincipalType": {
      "type": "string",
      "defaultValue": "User",
      "allowedValues": [
        "User",
        "Application"
      ],
      "metadata": {
        "description": "SQL Server Administrator Principal Type"
      }
    },
    "deployGenAI": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy GenAI resources (Azure OpenAI and AI Search)"
      }
    },
    "timestamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMddHHmm')]",
      "metadata": {
        "description": "Timestamp for unique naming (defaults to deployment time)"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "managedIdentity-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "timestamp": {
            "value": "[parameters('timestamp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11369879504058548154"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for the managed identity"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "timestamp": {
              "type": "string",
              "metadata": {
                "description": "Timestamp for unique naming"
              }
            }
          },
          "variables": {
            "managedIdentityName": "[format('mid-{0}-{1}', parameters('baseName'), parameters('timestamp'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[variables('managedIdentityName')]",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "managedIdentityId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]"
            },
            "managedIdentityName": {
              "type": "string",
              "value": "[variables('managedIdentityName')]"
            },
            "managedIdentityClientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2023-01-31').clientId]"
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2023-01-31').principalId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "sqlServerName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'azureSQL-deployment'), '2025-04-01').outputs.sqlServerName.value]"
          },
          "sqlDatabaseName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'azureSQL-deployment'), '2025-04-01').outputs.databaseName.value]"
          },
          "appServiceName": {
            "value": ""
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9329463710583754889"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for monitoring resources"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource naming"
              }
            },
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name"
              }
            },
            "sqlDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "SQL Database name"
              }
            },
            "appServiceName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "App Service name (optional - diagnostics configured separately)"
              }
            }
          },
          "variables": {
            "logAnalyticsWorkspaceName": "[toLower(format('law-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix')))]",
            "appInsightsName": "[toLower(format('appi-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix')))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Sql/servers/{0}/databases/{1}', split(format('{0}/{1}', parameters('sqlServerName'), parameters('sqlDatabaseName')), '/')[0], split(format('{0}/{1}', parameters('sqlServerName'), parameters('sqlDatabaseName')), '/')[1])]",
              "name": "SQLDatabaseDiagnostics",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]",
                "logs": [
                  {
                    "category": "SQLInsights",
                    "enabled": true
                  },
                  {
                    "category": "AutomaticTuning",
                    "enabled": true
                  },
                  {
                    "category": "QueryStoreRuntimeStatistics",
                    "enabled": true
                  },
                  {
                    "category": "QueryStoreWaitStatistics",
                    "enabled": true
                  },
                  {
                    "category": "Errors",
                    "enabled": true
                  },
                  {
                    "category": "DatabaseWaitStatistics",
                    "enabled": true
                  },
                  {
                    "category": "Timeouts",
                    "enabled": true
                  },
                  {
                    "category": "Blocks",
                    "enabled": true
                  },
                  {
                    "category": "Deadlocks",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "Basic",
                    "enabled": true
                  },
                  {
                    "category": "InstanceAndAppAdvanced",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('appServiceName')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appServiceName'))]",
              "name": "AppServiceDiagnostics",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServicePlatformLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[variables('logAnalyticsWorkspaceName')]"
            },
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'azureSQL-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appService-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment'), '2025-04-01').outputs.managedIdentityId.value]"
          },
          "managedIdentityClientId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment'), '2025-04-01').outputs.managedIdentityClientId.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.appInsightsConnectionString.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7854571521431657097"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for the App Service"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource naming"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity resource ID"
              }
            },
            "managedIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Client ID"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights Connection String"
              }
            }
          },
          "variables": {
            "appServicePlanName": "[toLower(format('asp-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix')))]",
            "webAppName": "[toLower(format('app-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "S1",
                "tier": "Standard",
                "capacity": 1
              },
              "kind": "linux",
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[variables('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app,linux",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|8.0",
                  "alwaysOn": true,
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "http20Enabled": true,
                  "appSettings": [
                    {
                      "name": "AZURE_CLIENT_ID",
                      "value": "[parameters('managedIdentityClientId')]"
                    },
                    {
                      "name": "ManagedIdentityClientId",
                      "value": "[parameters('managedIdentityClientId')]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "XDT_MicrosoftApplicationInsights_Mode",
                      "value": "recommended"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
              ]
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[variables('webAppName')]"
            },
            "webAppHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2023-01-01').defaultHostName]"
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "value": "[parameters('managedIdentityClientId')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'monitoring-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appServiceDiagnostics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService-deployment'), '2025-04-01').outputs.webAppName.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9748571088544308044"
            }
          },
          "parameters": {
            "appServiceName": {
              "type": "string",
              "metadata": {
                "description": "App Service name"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appServiceName'))]",
              "name": "AppServiceDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServicePlatformLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appService-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'monitoring-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "azureSQL-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "adminObjectId": {
            "value": "[parameters('adminObjectId')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPrincipalType": {
            "value": "[parameters('adminPrincipalType')]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment'), '2025-04-01').outputs.managedIdentityPrincipalId.value]"
          },
          "managedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment'), '2025-04-01').outputs.managedIdentityName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11582005048813951836"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for the SQL Server"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource naming"
              }
            },
            "adminObjectId": {
              "type": "string",
              "metadata": {
                "description": "SQL Server Administrator Object ID"
              }
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "SQL Server Administrator User Principal Name or Display Name"
              }
            },
            "adminPrincipalType": {
              "type": "string",
              "defaultValue": "User",
              "allowedValues": [
                "User",
                "Application"
              ],
              "metadata": {
                "description": "SQL Server Administrator Principal Type"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Principal ID for database access"
              }
            },
            "managedIdentityName": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Name"
              }
            }
          },
          "variables": {
            "sqlServerName": "[toLower(format('sql-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix')))]",
            "databaseName": "Northwind"
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-05-01-preview",
              "name": "[variables('sqlServerName')]",
              "location": "[parameters('location')]",
              "properties": {
                "administrators": {
                  "administratorType": "ActiveDirectory",
                  "principalType": "[parameters('adminPrincipalType')]",
                  "login": "[parameters('adminUsername')]",
                  "sid": "[parameters('adminObjectId')]",
                  "tenantId": "[subscription().tenantId]",
                  "azureADOnlyAuthentication": true
                },
                "publicNetworkAccess": "Enabled",
                "minimalTlsVersion": "1.2"
              }
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerName'), 'AllowAllWindowsAzureIps')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerName'), variables('databaseName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic",
                "tier": "Basic"
              },
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": 2147483648
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            }
          ],
          "outputs": {
            "sqlServerName": {
              "type": "string",
              "value": "[variables('sqlServerName')]"
            },
            "sqlServerFqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Sql/servers', variables('sqlServerName')), '2023-05-01-preview').fullyQualifiedDomainName]"
            },
            "databaseName": {
              "type": "string",
              "value": "[variables('databaseName')]"
            },
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers/databases', variables('sqlServerName'), variables('databaseName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment')]"
      ]
    },
    {
      "condition": "[parameters('deployGenAI')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "genAI-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment'), '2025-04-01').outputs.managedIdentityPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11638764307384545318"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource naming"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Principal ID for role assignments"
              }
            }
          },
          "variables": {
            "openAIName": "[toLower(format('aoai-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix')))]",
            "searchName": "[toLower(format('srch-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix')))]",
            "modelDeploymentName": "gpt-4o",
            "modelName": "gpt-4o",
            "modelVersion": "2024-08-06",
            "openAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
            "searchIndexDataReaderRoleId": "1407120a-92aa-4202-b7e9-c0e197c71c8f"
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[variables('openAIName')]",
              "location": "swedencentral",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[variables('openAIName')]",
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('openAIName'), variables('modelDeploymentName'))]",
              "sku": {
                "name": "Standard",
                "capacity": 8
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[variables('modelName')]",
                  "version": "[variables('modelVersion')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAIName'))]"
              ]
            },
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2023-11-01",
              "name": "[variables('searchName')]",
              "location": "uksouth",
              "sku": {
                "name": "basic"
              },
              "properties": {
                "replicaCount": 1,
                "partitionCount": 1,
                "hostingMode": "default",
                "publicNetworkAccess": "enabled"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', variables('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIName')), parameters('managedIdentityPrincipalId'), variables('openAIUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('openAIUserRoleId'))]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAIName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', variables('searchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', variables('searchName')), parameters('managedIdentityPrincipalId'), variables('searchIndexDataReaderRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataReaderRoleId'))]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', variables('searchName'))]"
              ]
            }
          ],
          "outputs": {
            "openAIName": {
              "type": "string",
              "value": "[variables('openAIName')]"
            },
            "openAIEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIName')), '2023-05-01').endpoint]"
            },
            "openAIModelName": {
              "type": "string",
              "value": "[variables('modelDeploymentName')]"
            },
            "searchName": {
              "type": "string",
              "value": "[variables('searchName')]"
            },
            "searchEndpoint": {
              "type": "string",
              "value": "[format('https://{0}.search.windows.net', variables('searchName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "location": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "webAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService-deployment'), '2025-04-01').outputs.webAppName.value]"
    },
    "webAppHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService-deployment'), '2025-04-01').outputs.webAppHostName.value]"
    },
    "sqlServerName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'azureSQL-deployment'), '2025-04-01').outputs.sqlServerName.value]"
    },
    "sqlServerFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'azureSQL-deployment'), '2025-04-01').outputs.sqlServerFqdn.value]"
    },
    "databaseName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'azureSQL-deployment'), '2025-04-01').outputs.databaseName.value]"
    },
    "managedIdentityName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment'), '2025-04-01').outputs.managedIdentityName.value]"
    },
    "managedIdentityClientId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment'), '2025-04-01').outputs.managedIdentityClientId.value]"
    },
    "managedIdentityPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdentity-deployment'), '2025-04-01').outputs.managedIdentityPrincipalId.value]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.appInsightsConnectionString.value]"
    },
    "openAIEndpoint": {
      "type": "string",
      "value": "[if(and(parameters('deployGenAI'), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01'), null()))), reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01').outputs.openAIEndpoint.value, '')]"
    },
    "openAIModelName": {
      "type": "string",
      "value": "[if(and(parameters('deployGenAI'), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01'), null()))), reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01').outputs.openAIModelName.value, '')]"
    },
    "openAIName": {
      "type": "string",
      "value": "[if(and(parameters('deployGenAI'), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01'), null()))), reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01').outputs.openAIName.value, '')]"
    },
    "searchEndpoint": {
      "type": "string",
      "value": "[if(and(parameters('deployGenAI'), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01'), null()))), reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01').outputs.searchEndpoint.value, '')]"
    },
    "searchName": {
      "type": "string",
      "value": "[if(and(parameters('deployGenAI'), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01'), null()))), reference(resourceId('Microsoft.Resources/deployments', 'genAI-deployment'), '2025-04-01').outputs.searchName.value, '')]"
    }
  }
}