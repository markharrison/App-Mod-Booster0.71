@page
@model ExpenseManagement.Pages.ChatModel
@{
    ViewData["Title"] = "AI Chat Assistant";
}

<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-chat-dots-fill"></i> AI Chat Assistant
    </h1>

    @if (!Model.IsConfigured)
    {
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> GenAI Not Configured</h4>
            <p>Azure OpenAI resources have not been deployed yet. The chat feature requires Azure OpenAI to function.</p>
            <hr>
            <p class="mb-0">
                <strong>To enable the chat feature:</strong><br>
                Run the infrastructure deployment with the <code>-DeployGenAI</code> switch:
            </p>
            <pre class="bg-dark text-light p-2 rounded mt-2"><code>.\deploy-infra\deploy.ps1 -ResourceGroup "rg-expensemgmt-YYYYMMDD" -Location "uksouth" -DeployGenAI</code></pre>
        </div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body">
                <div id="chat-container" class="mb-3" style="height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; background-color: #f8f9fa;">
                    <div class="chat-message assistant mb-3">
                        <div class="d-flex align-items-start">
                            <div class="badge bg-primary rounded-circle p-2 me-2">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content bg-white p-3 rounded shadow-sm">
                                <p class="mb-0">Hello! I'm your expense management assistant. I can help you:</p>
                                <ul class="mb-0 mt-2">
                                    <li>View and search expenses</li>
                                    <li>Create new expense records</li>
                                    <li>Approve or reject expenses</li>
                                    <li>Get expense details by ID</li>
                                </ul>
                                <p class="mb-0 mt-2">How can I help you today?</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <input type="text" 
                           id="user-input" 
                           class="form-control" 
                           placeholder="Type your message here..." 
                           aria-label="Chat message"
                           autocomplete="off">
                    <button class="btn btn-primary" type="button" id="send-button">
                        <i class="bi bi-send-fill"></i> Send
                    </button>
                </div>
                
                <div id="loading-indicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">AI is thinking...</p>
                </div>
            </div>
        </div>

        <div class="card mt-3 shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-lightbulb-fill text-warning"></i> Example Questions</h5>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm example-btn">Show me all submitted expenses</button>
                    <button class="btn btn-outline-secondary btn-sm example-btn">Create an expense for Â£50 for lunch today</button>
                    <button class="btn btn-outline-secondary btn-sm example-btn">What are the available categories?</button>
                    <button class="btn btn-outline-secondary btn-sm example-btn">Show me expense #1</button>
                    <button class="btn btn-outline-secondary btn-sm example-btn">Approve expense #1</button>
                </div>
            </div>
        </div>
    }
</div>

@if (Model.IsConfigured)
{
    <style>
        .chat-message.user .message-content {
            background-color: #0d6efd;
            color: white;
            margin-left: auto;
        }
        
        .chat-message.assistant .message-content {
            background-color: white;
        }
        
        .message-content {
            max-width: 80%;
            word-wrap: break-word;
        }
        
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #chat-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const conversationHistory = [];

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            // XSS Safety: First escape ALL HTML to neutralize any potential injection
            // This converts <, >, & to HTML entities, making any script tags harmless
            let formatted = escapeHtml(text);
            
            // Then apply safe markdown-style formatting using simple regex replacements
            // These replacements only add specific, safe HTML tags and cannot introduce script injection
            // because the content has already been escaped
            
            // Bold text
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Convert numbered lists
            formatted = formatted.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            if (formatted.includes('<li>')) {
                formatted = '<ol>' + formatted + '</ol>';
            }
            
            // Convert bullet lists
            formatted = formatted.replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>');
            if (formatted.includes('<li>') && !formatted.includes('<ol>')) {
                formatted = '<ul>' + formatted + '</ul>';
            }
            
            // Line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user' : 'assistant'} mb-3`;
            
            const alignmentClass = isUser ? 'justify-content-end' : 'justify-content-start';
            const icon = isUser ? 'person-fill' : 'robot';
            const bgColor = isUser ? 'bg-success' : 'bg-primary';
            
            messageDiv.innerHTML = `
                <div class="d-flex align-items-start ${alignmentClass}">
                    ${!isUser ? `<div class="badge ${bgColor} rounded-circle p-2 me-2"><i class="bi bi-${icon}"></i></div>` : ''}
                    <div class="message-content p-3 rounded shadow-sm">
                        ${isUser ? escapeHtml(text) : formatMessage(text)}
                    </div>
                    ${isUser ? `<div class="badge ${bgColor} rounded-circle p-2 ms-2"><i class="bi bi-${icon}"></i></div>` : ''}
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Disable input while processing
            userInput.disabled = true;
            sendButton.disabled = true;
            loadingIndicator.style.display = 'block';

            // Add user message to UI
            addMessage(message, true);
            userInput.value = '';

            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationHistory: conversationHistory
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response from server');
                }

                const data = await response.json();
                
                // Add assistant response to UI
                addMessage(data.response, false);
                
                // Add to conversation history
                conversationHistory.push({ role: 'assistant', content: data.response });

            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, I encountered an error. Please try again.', false);
            } finally {
                // Re-enable input
                userInput.disabled = false;
                sendButton.disabled = false;
                loadingIndicator.style.display = 'none';
                userInput.focus();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Example button handlers
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                userInput.value = btn.textContent;
                userInput.focus();
            });
        });

        // Focus input on load
        userInput.focus();
    </script>
}
