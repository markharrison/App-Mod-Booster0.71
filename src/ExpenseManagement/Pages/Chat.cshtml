@page
@model ExpenseManagement.Pages.ChatModel
@{
    ViewData["Title"] = "AI Chat";
}

<div class="chat-page">
    <h1>AI Assistant</h1>
    
    @if (!Model.IsConfigured)
    {
        <div class="not-configured">
            <span class="icon">ðŸ¤–</span>
            <h2>AI Chat is not available yet</h2>
            <p>To enable the AI assistant, redeploy the infrastructure using the <code>-DeployGenAI</code> switch:</p>
            <pre>.\deploy-infra\deploy.ps1 -ResourceGroup "your-rg" -Location "uksouth" -DeployGenAI</pre>
            <p>The AI assistant can help you:</p>
            <ul>
                <li>View and filter expenses using natural language</li>
                <li>Create new expense records</li>
                <li>Approve or reject submitted expenses</li>
                <li>Get summaries and statistics</li>
            </ul>
        </div>
    }
    else
    {
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-content">
                        Hello! I'm your Expense Management assistant. I can help you:
                        <ul>
                            <li>View and search expenses</li>
                            <li>Create new expense records</li>
                            <li>Approve or reject submitted expenses</li>
                            <li>Get summaries and statistics</li>
                        </ul>
                        How can I help you today?
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Ask me about expenses..." />
                <button id="sendButton" class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    }
</div>

@if (Model.IsConfigured)
{
    @section Scripts {
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        let conversationHistory = [];

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message to UI
            addMessage('user', message);
            chatInput.value = '';
            sendButton.disabled = true;

            // Add to history
            conversationHistory.push({ role: 'user', content: message });

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(0, -1) // Exclude current message (it's in 'message' field)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage('assistant', data.response);
                    conversationHistory.push({ role: 'assistant', content: data.response });
                } else {
                    addMessage('error', data.error || 'An error occurred');
                }
            } catch (error) {
                addMessage('error', 'Failed to send message: ' + error.message);
            }

            sendButton.disabled = false;
            chatInput.focus();
        }

        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Format the content - escape HTML first, then convert markdown
            const formattedContent = formatContent(content);
            contentDiv.innerHTML = formattedContent;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatContent(content) {
            // Escape HTML to prevent XSS
            let escaped = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            // Convert markdown-style formatting to HTML
            // Bold text
            escaped = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Numbered lists
            escaped = escaped.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            escaped = escaped.replace(/(<li>.*<\/li>\n?)+/g, '<ol>$&</ol>');
            
            // Bullet points
            escaped = escaped.replace(/^[-â€¢]\s+(.+)$/gm, '<li>$1</li>');
            escaped = escaped.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
                if (!match.includes('<ol>')) {
                    return '<ul>' + match + '</ul>';
                }
                return match;
            });

            // Line breaks
            escaped = escaped.replace(/\n/g, '<br>');

            return escaped;
        }
    </script>
    }
}
