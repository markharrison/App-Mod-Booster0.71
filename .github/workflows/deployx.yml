name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deployGenAI:
        description: 'Deploy GenAI resources (Azure OpenAI, AI Search)'
        required: false
        type: boolean
        default: false

# OIDC authentication requires these permissions
permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: rg-expensemgmt-${{ github.run_number }}
  LOCATION: uksouth
  BASE_NAME: expensemgmt

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      - name: Install go-sqlcmd
        run: |
          curl -sSL -o sqlcmd.tar.bz2 https://github.com/microsoft/go-sqlcmd/releases/download/v1.8.0/sqlcmd-linux-amd64.tar.bz2
          sudo tar -xjf sqlcmd.tar.bz2 -C /usr/local/bin
          sqlcmd --version
      
      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell
      
      - name: Deploy Infrastructure
        shell: pwsh
        env:
          AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
        run: |
          $deployGenAI = "${{ github.event.inputs.deployGenAI }}" -eq "true"
          
          $infraArgs = @{
            ResourceGroup = "${{ env.RESOURCE_GROUP }}"
            Location      = "${{ env.LOCATION }}"
            BaseName      = "${{ env.BASE_NAME }}"
          }
          
          if ($deployGenAI) {
            $infraArgs["DeployGenAI"] = $true
          }
          
          ./deploy-infra/deploy.ps1 @infraArgs
      
      - name: Wait for App Service to stabilize
        run: |
          echo "Waiting 60 seconds for App Service settings to apply..."
          sleep 60
      
      - name: Verify deployment context exists
        shell: pwsh
        run: |
          if (Test-Path ".deployment-context.json") {
            Write-Host "âœ“ Deployment context file found"
            Get-Content ".deployment-context.json" | Write-Host
          } else {
            Write-Error "deployment-context.json not found. Infrastructure deployment may have failed silently."
            exit 1
          }

      - name: Upload deployment context
        uses: actions/upload-artifact@v4
        with:
          name: deployment-context
          path: .deployment-context.json
          include-hidden-files: true
          retention-days: 1

  deploy-application:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      - name: Download deployment context
        uses: actions/download-artifact@v4
        with:
          name: deployment-context
          path: .
      
      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell
      
      - name: Deploy Application
        shell: pwsh
        run: |
          ./deploy-app/deploy.ps1
