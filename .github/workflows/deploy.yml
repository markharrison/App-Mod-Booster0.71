name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      resourceGroup:
        description: 'Resource Group Name'
        required: true
        default: 'rg-expensemgmt-cicd'
      location:
        description: 'Azure Region'
        required: true
        default: 'uksouth'
      deployGenAI:
        description: 'Deploy GenAI Resources'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Infrastructure and Application
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      - name: Install sqlcmd
        run: |
          curl -sSL -o sqlcmd.tar.bz2 https://github.com/microsoft/go-sqlcmd/releases/download/v1.8.0/sqlcmd-linux-amd64.tar.bz2
          sudo tar -xjf sqlcmd.tar.bz2 -C /usr/local/bin
          sqlcmd --version
      
      - name: Deploy Infrastructure
        shell: pwsh
        run: |
          $params = @{
              ResourceGroup = "${{ github.event.inputs.resourceGroup }}"
              Location = "${{ github.event.inputs.location }}"
          }
          
          if ("${{ github.event.inputs.deployGenAI }}" -eq "true") {
              $params["DeployGenAI"] = $true
          }
          
          ./deploy-infra/deploy.ps1 @params
      
      - name: Wait for App Service to stabilize
        run: |
          echo "Waiting 60 seconds for App Service settings to apply..."
          sleep 60
      
      - name: Deploy Application
        shell: pwsh
        run: |
          ./deploy-app/deploy.ps1
      
      - name: Deployment Summary
        run: |
          echo "### Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ github.event.inputs.resourceGroup }}" >> $GITHUB_STEP_SUMMARY
          echo "**Location:** ${{ github.event.inputs.location }}" >> $GITHUB_STEP_SUMMARY
          echo "**GenAI Deployed:** ${{ github.event.inputs.deployGenAI }}" >> $GITHUB_STEP_SUMMARY
