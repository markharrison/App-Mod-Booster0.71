name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      resourceGroup:
        description: 'Resource Group Name'
        required: true
        default: 'rg-expensemgmt-cicd'
      location:
        description: 'Azure Region'
        required: true
        default: 'uksouth'
      deployGenAI:
        description: 'Deploy GenAI Resources'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      webAppName: ${{ steps.deploy-infra.outputs.webAppName }}
      resourceGroup: ${{ github.event.inputs.resourceGroup }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Install sqlcmd
        run: |
          echo "Installing go-sqlcmd..."
          curl -sSL -o sqlcmd.tar.bz2 https://github.com/microsoft/go-sqlcmd/releases/download/v1.8.0/sqlcmd-linux-amd64.tar.bz2
          sudo tar -xjf sqlcmd.tar.bz2 -C /usr/local/bin
          sqlcmd --version

      - name: Deploy Infrastructure
        id: deploy-infra
        shell: pwsh
        run: |
          $deployGenAI = "${{ github.event.inputs.deployGenAI }}" -eq "true"
          $params = @{
            ResourceGroup = "${{ github.event.inputs.resourceGroup }}"
            Location = "${{ github.event.inputs.location }}"
            BaseName = "expensemgmt"
          }
          if ($deployGenAI) {
            $params.DeployGenAI = $true
          }
          ./deploy-infra/deploy.ps1 @params

      - name: Get deployment outputs
        id: get-outputs
        shell: pwsh
        run: |
          $context = Get-Content .deployment-context.json | ConvertFrom-Json
          echo "webAppName=$($context.webAppName)" >> $env:GITHUB_OUTPUT
          echo "Web App Name: $($context.webAppName)"

      - name: Upload deployment context
        uses: actions/upload-artifact@v4.4.3
        with:
          name: deployment-context
          path: .deployment-context.json

  deploy-application:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Download deployment context
        uses: actions/download-artifact@v4.1.3
        with:
          name: deployment-context
          path: .

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Wait for App Service to stabilize
        run: |
          echo "Waiting 60 seconds for App Service settings to apply..."
          sleep 60

      - name: Deploy Application
        shell: pwsh
        run: |
          ./deploy-app/deploy.ps1

      - name: Display Application URLs
        shell: pwsh
        run: |
          $context = Get-Content .deployment-context.json | ConvertFrom-Json
          $webAppDetails = az webapp show --resource-group $context.resourceGroup --name $context.webAppName --output json | ConvertFrom-Json
          $appUrl = "https://$($webAppDetails.defaultHostDomainName)"
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Deployment Complete!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Application URLs:" -ForegroundColor Yellow
          Write-Host "  Main App: $appUrl/Index" -ForegroundColor White
          Write-Host "  API Docs: $appUrl/swagger" -ForegroundColor White
          Write-Host ""
