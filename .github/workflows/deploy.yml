name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      resourceGroup:
        description: 'Azure Resource Group name (should be unique with date)'
        required: true
        default: 'rg-expensemgmt-cicd'
      location:
        description: 'Azure region (e.g., uksouth, eastus)'
        required: true
        default: 'uksouth'
      baseName:
        description: 'Base name for resources'
        required: false
        default: 'expensemgmt'
      deployGenAI:
        description: 'Deploy GenAI resources (Azure OpenAI and AI Search)'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Infrastructure and Application
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      - name: Install sqlcmd
        run: |
          echo "Installing go-sqlcmd from GitHub releases..."
          curl -sSL -o sqlcmd.tar.bz2 https://github.com/microsoft/go-sqlcmd/releases/download/v1.8.0/sqlcmd-linux-amd64.tar.bz2
          sudo tar -xjf sqlcmd.tar.bz2 -C /usr/local/bin
          sqlcmd --version
      
      - name: Deploy Infrastructure
        shell: pwsh
        run: |
          $params = @{
              ResourceGroup = "${{ github.event.inputs.resourceGroup }}"
              Location = "${{ github.event.inputs.location }}"
              BaseName = "${{ github.event.inputs.baseName }}"
          }
          
          if ("${{ github.event.inputs.deployGenAI }}" -eq "true") {
              $params["DeployGenAI"] = $true
          }
          
          ./deploy-infra/deploy.ps1 @params
      
      - name: Wait for App Service to stabilize
        run: |
          echo "Waiting 60 seconds for App Service settings to apply..."
          sleep 60
      
      - name: Deploy Application
        shell: pwsh
        run: |
          ./deploy-app/deploy.ps1
      
      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ github.event.inputs.resourceGroup }}" >> $GITHUB_STEP_SUMMARY
          echo "**Location:** ${{ github.event.inputs.location }}" >> $GITHUB_STEP_SUMMARY
          echo "**GenAI Deployed:** ${{ github.event.inputs.deployGenAI }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f ".deployment-context.json" ]; then
            echo "**Application URLs:**" >> $GITHUB_STEP_SUMMARY
            CONTEXT=$(cat .deployment-context.json)
            WEB_APP_NAME=$(echo $CONTEXT | jq -r '.webAppName')
            echo "- Main App: https://${WEB_APP_NAME}.azurewebsites.net/Index" >> $GITHUB_STEP_SUMMARY
            echo "- API Docs: https://${WEB_APP_NAME}.azurewebsites.net/swagger" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.deployGenAI }}" = "true" ]; then
              echo "- AI Chat: https://${WEB_APP_NAME}.azurewebsites.net/Chat" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: Upload deployment context
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-context
          path: .deployment-context.json
          retention-days: 30
